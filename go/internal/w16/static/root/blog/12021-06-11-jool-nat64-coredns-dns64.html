<!doctype html><html lang=en><meta charset=utf-8><meta name=viewport content="width=device-width,minimum-scale=1,initial-scale=1"><title>jool nat64, coredns dns64</title><script>(function(b,d,e,a,g){b[a]=b[a]||[],b[a].push({"gtm.start":(new Date).getTime(),event:"gtm.js"});var f=d.getElementsByTagName(e)[0],c=d.createElement(e),h=a!="dataLayer"?"&l="+a:"";c.async=!0,c.src="https://www.googletagmanager.com/gtm.js?id="+g+h,f.parentNode.insertBefore(c,f)})(window,document,"script","dataLayer","GTM-TLVN7D6")</script><link rel=canonical href=https://seankhliao.com/blog/12021-06-11-jool-nat64-coredns-dns64/><link rel=manifest href=/manifest.json><meta name=theme-color content="#000000"><meta name=description content="setting up nat64 and dns64"><link rel=icon href=https://seankhliao.com/favicon.ico><link rel=icon href=https://seankhliao.com/static/icon.svg type=image/svg+xml sizes=any><link rel=apple-touch-icon href=https://seankhliao.com/static/icon-192.png><style>*{box-sizing:border-box}:root{background:#000;color:#eceff1;font:18px inconsolata,monospace}@font-face{font-family:inconsolata;font-style:normal;font-weight:400;font-display:swap;src:local("Inconsolata"),local("Inconsolata-Regular"),url(https://seankhliao.com/static/inconsolata-var.woff2)format("woff2-variations"),url(https://seankhliao.com/static/inconsolata-400.woff2)format("woff2")}@font-face{font-family:inconsolata;font-style:normal;font-weight:700;font-display:swap;src:local("Inconsolata Bold"),local("Inconsolata-Bold"),url(https://seankhliao.com/static/inconsolata-var.woff2)format("woff2-variations"),url(https://seankhliao.com/static/inconsolata-700.woff2)format("woff2")}@font-face{font-family:lora;font-style:normal;font-weight:400;font-display:swap;src:local("Lora"),local("Lora-Regular"),url(https://seankhliao.com/static/lora-var.woff2)format("woff2-variations"),url(https://seankhliao.com/static/lora-400.woff2)format("woff2")}@font-face{font-family:lora;font-style:normal;font-weight:700;font-display:swap;src:local("Lora Bold"),local("Lora-Bold"),url(https://seankhliao.com/static/lora-var.woff2)format("woff2-variations"),url(https://seankhliao.com/static/lora-700.woff2)format("woff2")}body{grid:20vh 60vh/1fr repeat(3,minmax(90px,280px))1fr;display:grid;gap:0 1em;margin:0;padding:1vmin;background:#000;color:#eceff1;font:18px inconsolata,monospace}body>*{grid-column:2/span 3}h1{font-size:4.5vmin;grid-area:1/4/span 1/span 2;margin:0;place-self:end}h2{color:#999;font-size:3.5vmin;grid-area:2/4/span 1/span 2;place-self:start end;text-align:right}hgroup{font:700 5vmin lora,serif;grid-area:1/1/span 2/span 2;margin:0;place-self:end start}hgroup a{display:grid;grid:repeat(2,10vmin)/repeat(8,10vmin);place-content:center center}hgroup *:nth-child(n+5){grid-row:2/span 1}footer,iframe,pre,table,picture{grid-column:1/span 5;margin:.25em -1vmin 2em}picture img{width:100%;margin:auto}h3,h4,picture{margin:25vh 0 .25em}h5,h6{margin:1.5em 0 .25em}h3{font-size:2.441em}h4{font-size:1.953em}h5{font-size:1.563em}h6{font-size:1.25em}p{line-height:1.5;margin:0 0 1em}footer{margin:10vh auto 3vh}a,a:visited{color:inherit;font-weight:700;text-decoration:underline 1px #707070}a:hover{color:#a06be0;transition:color .16s;text-decoration:underline 1px #a06be0}h1 a,h1 a:hover,h1 a:visited,hgroup a,hgroup a:hover,hgroup a:visited{color:inherit;text-decoration:none}ul{list-style:none;margin:0}ul>*{margin:.5em;line-height:1.5em}ul>li:before{content:"Â»";margin:0 1ch 0 -3ch;position:absolute}ol>*{line-height:1.75em}blockquote{margin:1em;padding:.25em 1em;border-left:1ch solid #999}code{background:#303030;font:1em inconsolata,monospace;padding:.1em}pre{background:#303030;overflow-x:scroll;padding:1em}pre::-webkit-scrollbar{display:none}pre code{padding:0}iframe{margin:auto}em{color:#a06be0;background-color:unset;font-style:normal;font-weight:700}time{color:#999}table{border-collapse:collapse;border-style:hidden}th,td{padding:.4em;text-align:left}th{font-weight:700;border-bottom:.2em solid #999}tr:nth-child(5n) td{border-bottom:.1em solid #999}tbody tr:hover{background:#404040}noscript iframe{height:0;width:0;display:none;visibility:hidden}</style><noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-TLVN7D6" height=0 width=0 style=display:none;visibility:hidden></iframe></noscript><h1><a href=/blog/>b<em>log</em></a></h1><h2>12021-06-11</h2><hgroup><a href=/><span>S</span><span>E</span><span>A</span><span>N</span>
<em>K</em><em>.</em><em>H</em><em>.</em>
<span>L</span><span>I</span><span>A</span><span>O</span></a></hgroup><h3 id=-ipv6-><em>ipv6</em></h3><p>Why can't the world just use ipv6?
Ah yes, longer addresses that are hard to remember,
another set of dns entries to create,
and sometimes (often?) your users don't have it anyway so why bother?<p>Anyway, you have some ipv6 network (maybe k8s kind in ipv6 mode?)
that needs to reach out to the ipv4 internet.
You (usually) need 2 things: <em>nat64</em> and <em>dns64</em>.<h4 id=-dns64-><em>dns64</em></h4><p>Problem: you request <code>example.com</code> but it only has an <code>A</code> record.<p>Solution: reply with a synthesized <code>AAAA</code> record using mapped addresses
(a section of ipv6 address space mapping directly to ipv4, eg <code>64:ff9b::192.0.2.128</code>).
<a href=https://datatracker.ietf.org/doc/html/rfc6052>RFC 6052</a> even reserves
the <code>64:ff9b::/96</code> range for translation.<h5 id=-coredns-><em>coredns</em></h5><p>Most documentation online uses <a href=https://www.isc.org/bind/>bind</a>,
but whatever, we're using <a href=https://coredns.io/>coredns</a>.
Enable the <code>dns64</code> plugin, and <code>forward</code> everything to upstream.
Oh, and set <code>acl</code> so you don't end up running an open resolver
(if you run it somewhere with public addresses).
This doesn't have to run on a dual stack node,
it just needs to talk to an upstream.<pre><code class=language-Corefile>. {
	dns64
	forward . 8.8.8.8:53

	errors
	log
	acl {
		allow net 10.0.0.0/8 172.16.0.0/12 192.168.0.0/16 127.0.0.0/8
		allow net fc00:f853:ccd:e793::/64 ::1/128
		block
	}
}
</code></pre><h4 id=-nat64-><em>nat64</em></h4><p>Problem: you have your "fake" ipv6 address for your destination now,
but you still need to be able to send data to it.<p>Solution: have your gateway (dual stack) understand your mapped prefix
and translate + nat everything with a destination there from ipv6 to ipv4.<h5 id=-jool-><em>jool</em></h5><p><a href=https://www.jool.mx/en/index.html>jool</a> appears to be the only reasonable choice here.
It's a kernel module. Install it, <code>modprobe jool</code>, <code>jool file handle $config</code>.
<code>pool6</code> is the prefix to recognize as containing ipv4 addresses.
One thing to note, it's <a href=https://www.jool.mx/en/faq.html#why-is-my-ping-not-working>implemented as <code>PRE_ROUTING</code></a>
so you need to have a separate network namespace to test it.<pre><code class=language-json>{
	&quot;instance&quot;: &quot;default&quot;,
	&quot;framework&quot;: &quot;netfilter&quot;,
	&quot;global&quot;: {
		&quot;pool6&quot;: &quot;64:ff9b::/96&quot;
	}
}
</code></pre><footer><a href=https://seankhliao.com/>home</a>
|
<a href=https://seankhliao.com/blog/>blog</a>
|
<a href=https://github.com/seankhliao>github</a></footer>