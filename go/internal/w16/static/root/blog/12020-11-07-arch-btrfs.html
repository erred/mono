<!doctype html><html lang=en><meta charset=utf-8><meta name=viewport content="width=device-width,minimum-scale=1,initial-scale=1"><title>arch btrfs</title><script>(function(b,d,e,a,g){b[a]=b[a]||[],b[a].push({"gtm.start":(new Date).getTime(),event:"gtm.js"});var f=d.getElementsByTagName(e)[0],c=d.createElement(e),h=a!="dataLayer"?"&l="+a:"";c.async=!0,c.src="https://www.googletagmanager.com/gtm.js?id="+g+h,f.parentNode.insertBefore(c,f)})(window,document,"script","dataLayer","GTM-TLVN7D6")</script><link rel=canonical href=https://seankhliao.com/blog/12020-11-07-arch-btrfs/><link rel=manifest href=/manifest.json><meta name=theme-color content="#000000"><meta name=description content="btrfs as rootfs on arch"><link rel=icon href=https://seankhliao.com/favicon.ico><link rel=icon href=https://seankhliao.com/static/icon.svg type=image/svg+xml sizes=any><link rel=apple-touch-icon href=https://seankhliao.com/static/icon-192.png><style>*{box-sizing:border-box}:root{background:#000;color:#eceff1;font:18px inconsolata,monospace}@font-face{font-family:inconsolata;font-style:normal;font-weight:400;font-display:swap;src:local("Inconsolata"),local("Inconsolata-Regular"),url(https://seankhliao.com/static/inconsolata-var.woff2)format("woff2-variations"),url(https://seankhliao.com/static/inconsolata-400.woff2)format("woff2")}@font-face{font-family:inconsolata;font-style:normal;font-weight:700;font-display:swap;src:local("Inconsolata Bold"),local("Inconsolata-Bold"),url(https://seankhliao.com/static/inconsolata-var.woff2)format("woff2-variations"),url(https://seankhliao.com/static/inconsolata-700.woff2)format("woff2")}@font-face{font-family:lora;font-style:normal;font-weight:400;font-display:swap;src:local("Lora"),local("Lora-Regular"),url(https://seankhliao.com/static/lora-var.woff2)format("woff2-variations"),url(https://seankhliao.com/static/lora-400.woff2)format("woff2")}@font-face{font-family:lora;font-style:normal;font-weight:700;font-display:swap;src:local("Lora Bold"),local("Lora-Bold"),url(https://seankhliao.com/static/lora-var.woff2)format("woff2-variations"),url(https://seankhliao.com/static/lora-700.woff2)format("woff2")}body{grid:20vh 60vh/1fr repeat(3,minmax(90px,280px))1fr;display:grid;gap:0 1em;margin:0;padding:1vmin;background:#000;color:#eceff1;font:18px inconsolata,monospace}body>*{grid-column:2/span 3}h1{font-size:4.5vmin;grid-area:1/4/span 1/span 2;margin:0;place-self:end}h2{color:#999;font-size:3.5vmin;grid-area:2/4/span 1/span 2;place-self:start end;text-align:right}hgroup{font:700 5vmin lora,serif;grid-area:1/1/span 2/span 2;margin:0;place-self:end start}hgroup a{display:grid;grid:repeat(2,10vmin)/repeat(8,10vmin);place-content:center center}hgroup *:nth-child(n+5){grid-row:2/span 1}footer,iframe,pre,table,picture{grid-column:1/span 5;margin:.25em -1vmin 2em}picture img{width:100%;margin:auto}h3,h4,picture{margin:25vh 0 .25em}h5,h6{margin:1.5em 0 .25em}h3{font-size:2.441em}h4{font-size:1.953em}h5{font-size:1.563em}h6{font-size:1.25em}p{line-height:1.5;margin:0 0 1em}footer{margin:10vh auto 3vh}a,a:visited{color:inherit;font-weight:700;text-decoration:underline 1px #707070}a:hover{color:#a06be0;transition:color .16s;text-decoration:underline 1px #a06be0}h1 a,h1 a:hover,h1 a:visited,hgroup a,hgroup a:hover,hgroup a:visited{color:inherit;text-decoration:none}ul{list-style:none;margin:0}ul>*{margin:.5em;line-height:1.5em}ul>li:before{content:"Â»";margin:0 1ch 0 -3ch;position:absolute}ol>*{line-height:1.75em}blockquote{margin:1em;padding:.25em 1em;border-left:1ch solid #999}code{background:#303030;font:1em inconsolata,monospace;padding:.1em}pre{background:#303030;overflow-x:scroll;padding:1em}pre::-webkit-scrollbar{display:none}pre code{padding:0}iframe{margin:auto}em{color:#a06be0;background-color:unset;font-style:normal;font-weight:700}time{color:#999}table{border-collapse:collapse;border-style:hidden}th,td{padding:.4em;text-align:left}th{font-weight:700;border-bottom:.2em solid #999}tr:nth-child(5n) td{border-bottom:.1em solid #999}tbody tr:hover{background:#404040}noscript iframe{height:0;width:0;display:none;visibility:hidden}</style><noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-TLVN7D6" height=0 width=0 style=display:none;visibility:hidden></iframe></noscript><h1><a href=/blog/>b<em>log</em></a></h1><h2>12020-11-07</h2><hgroup><a href=/><span>S</span><span>E</span><span>A</span><span>N</span>
<em>K</em><em>.</em><em>H</em><em>.</em>
<span>L</span><span>I</span><span>A</span><span>O</span></a></hgroup><h3 id=-btrfs-><em>btrfs</em></h3><p>You've decided to stick your fingers in your ears,
ignoring all claims of instability and use btrfs as your root filesystem.
You want a subvolume as <code>/</code>.<p><em>notes:</em> btrfs subvolumes is best thought of as lightweight namespaces,
you mount the same partition for all (sub)volumes
and you specify the subvolume as a mount option.<h4 id=-hardware-><em>hardware</em></h4><p>tested on a dell xps9350: uefi, nvme ssd<h4 id=-steps-><em>steps</em></h4><ol><li>create paritions:<ol><li>EFI partition<li>root partition</ol><li>create filesystems<ol><li><code>mkfs.fat -F 32 /dev/nvme0n1p1</code><li><code>mkfs.btrfs /dev/nvme0n1p2</code></ol><li>setup btrfs, because btrfs is just a (heirarchical) set of namespaces,
we mount the btrfs root, create our subvolumes, then unmount it,
then remount the ones we actually need.
Alternatively you can mount the btrfs root elsewhere during setup, eg <code>/btrfs</code>.<ol><li><code>mount -o compress=zstd /dev/nvme0n1p2 /mnt</code><li><code>mkdir /mnt/arch</code><li><code>btrfs subvolume create /mnt/arch/@</code>, the <code>@</code> is just a naming convention<li><code>btrfs subvolume create /mnt/arch/@home</code><li><code>umount /mnt</code></ol><li>mount filesystems, where they will end up in your final system<ol><li><code>mount -o compress=zstd,subvol=arch/@ /dev/nvme0n1p2 /mnt</code><li><code>mkdir /mnt/boot</code><li><code>mount /dev/nvme0n1p1 /mnt/boot</code><li><code>mkdir /mnt/home</code><li><code>mount -o compress=zstd,subvol-arch/@home /dev/nvme0n1p2 /mnt/home</code></ol><li><code>timedatectl set-ntp true</code><li><code>iwd station wlan0 connect $network</code><li><code>reflector --save /etc/pacman.d/mirrorlist -f 5 -p https</code><li><code>pacstrap /mnt base base-devel linux linux-firmware intel-ucode btrfs-progs zsh zsh-completions iwd git neovim</code>, minimal set of things to work confortable after reboot<li><code>genfstab -U /mnt >> /mnt/etc/fstab</code><li><code>arch-chroot /mnt</code><li><code>passwd</code><li><code>bootctl install</code><li><code>echo "default arch\ntimeout 0\nconsole-mode max" > /boot/loader/loader.conf</code><li>create loader entry, see below<li>continue after rebooting into new system, some tools require the right systemd/dbus setup not available in chroot.</ol><h4 id=-bootloader-><em>bootloader</em></h4><p>The dell xps9350 has a shitty firmware that apparently doesn't pass the kernel cmdline properly(?) so systemd-boot is used<pre><code class=language-txt>title   Arch Linux
linux   /vmlinuz-linux
initrd  /intel-ucode.img
initrd  /initramfs-linux.img
options root=UUID=.... rootflags=compress=zstd:3,subvol=arch/@,... quiet rw
</code></pre><footer><a href=https://seankhliao.com/>home</a>
|
<a href=https://seankhliao.com/blog/>blog</a>
|
<a href=https://github.com/seankhliao>github</a></footer>