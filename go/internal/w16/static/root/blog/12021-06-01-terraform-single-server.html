<!doctype html><html lang=en><meta charset=utf-8><meta name=viewport content="width=device-width,minimum-scale=1,initial-scale=1"><title>terraform single server</title><script>(function(b,d,e,a,g){b[a]=b[a]||[],b[a].push({"gtm.start":(new Date).getTime(),event:"gtm.js"});var f=d.getElementsByTagName(e)[0],c=d.createElement(e),h=a!="dataLayer"?"&l="+a:"";c.async=!0,c.src="https://www.googletagmanager.com/gtm.js?id="+g+h,f.parentNode.insertBefore(c,f)})(window,document,"script","dataLayer","GTM-TLVN7D6")</script><link rel=canonical href=https://seankhliao.com/blog/12021-06-01-terraform-single-server/><link rel=manifest href=/manifest.json><meta name=theme-color content="#000000"><meta name=description content="using terraform for a bare metal server"><link rel=icon href=https://seankhliao.com/favicon.ico><link rel=icon href=https://seankhliao.com/static/icon.svg type=image/svg+xml sizes=any><link rel=apple-touch-icon href=https://seankhliao.com/static/icon-192.png><style>*{box-sizing:border-box}:root{background:#000;color:#eceff1;font:18px inconsolata,monospace}@font-face{font-family:inconsolata;font-style:normal;font-weight:400;font-display:swap;src:local("Inconsolata"),local("Inconsolata-Regular"),url(https://seankhliao.com/static/inconsolata-var.woff2)format("woff2-variations"),url(https://seankhliao.com/static/inconsolata-400.woff2)format("woff2")}@font-face{font-family:inconsolata;font-style:normal;font-weight:700;font-display:swap;src:local("Inconsolata Bold"),local("Inconsolata-Bold"),url(https://seankhliao.com/static/inconsolata-var.woff2)format("woff2-variations"),url(https://seankhliao.com/static/inconsolata-700.woff2)format("woff2")}@font-face{font-family:lora;font-style:normal;font-weight:400;font-display:swap;src:local("Lora"),local("Lora-Regular"),url(https://seankhliao.com/static/lora-var.woff2)format("woff2-variations"),url(https://seankhliao.com/static/lora-400.woff2)format("woff2")}@font-face{font-family:lora;font-style:normal;font-weight:700;font-display:swap;src:local("Lora Bold"),local("Lora-Bold"),url(https://seankhliao.com/static/lora-var.woff2)format("woff2-variations"),url(https://seankhliao.com/static/lora-700.woff2)format("woff2")}body{grid:20vh 60vh/1fr repeat(3,minmax(90px,280px))1fr;display:grid;gap:0 1em;margin:0;padding:1vmin;background:#000;color:#eceff1;font:18px inconsolata,monospace}body>*{grid-column:2/span 3}h1{font-size:4.5vmin;grid-area:1/4/span 1/span 2;margin:0;place-self:end}h2{color:#999;font-size:3.5vmin;grid-area:2/4/span 1/span 2;place-self:start end;text-align:right}hgroup{font:700 5vmin lora,serif;grid-area:1/1/span 2/span 2;margin:0;place-self:end start}hgroup a{display:grid;grid:repeat(2,10vmin)/repeat(8,10vmin);place-content:center center}hgroup *:nth-child(n+5){grid-row:2/span 1}footer,iframe,pre,table,picture{grid-column:1/span 5;margin:.25em -1vmin 2em}picture img{width:100%;margin:auto}h3,h4,picture{margin:25vh 0 .25em}h5,h6{margin:1.5em 0 .25em}h3{font-size:2.441em}h4{font-size:1.953em}h5{font-size:1.563em}h6{font-size:1.25em}p{line-height:1.5;margin:0 0 1em}footer{margin:10vh auto 3vh}a,a:visited{color:inherit;font-weight:700;text-decoration:underline 1px #707070}a:hover{color:#a06be0;transition:color .16s;text-decoration:underline 1px #a06be0}h1 a,h1 a:hover,h1 a:visited,hgroup a,hgroup a:hover,hgroup a:visited{color:inherit;text-decoration:none}ul{list-style:none;margin:0}ul>*{margin:.5em;line-height:1.5em}ul>li:before{content:"Â»";margin:0 1ch 0 -3ch;position:absolute}ol>*{line-height:1.75em}blockquote{margin:1em;padding:.25em 1em;border-left:1ch solid #999}code{background:#303030;font:1em inconsolata,monospace;padding:.1em}pre{background:#303030;overflow-x:scroll;padding:1em}pre::-webkit-scrollbar{display:none}pre code{padding:0}iframe{margin:auto}em{color:#a06be0;background-color:unset;font-style:normal;font-weight:700}time{color:#999}table{border-collapse:collapse;border-style:hidden}th,td{padding:.4em;text-align:left}th{font-weight:700;border-bottom:.2em solid #999}tr:nth-child(5n) td{border-bottom:.1em solid #999}tbody tr:hover{background:#404040}noscript iframe{height:0;width:0;display:none;visibility:hidden}</style><noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-TLVN7D6" height=0 width=0 style=display:none;visibility:hidden></iframe></noscript><h1><a href=/blog/>b<em>log</em></a></h1><h2>12021-06-01</h2><hgroup><a href=/><span>S</span><span>E</span><span>A</span><span>N</span>
<em>K</em><em>.</em><em>H</em><em>.</em>
<span>L</span><span>I</span><span>A</span><span>O</span></a></hgroup><h3 id=-terraform-><em>terraform</em></h3><p><a href=https://www.terraform.io/>terraform</a> rightly describes itself as a provisioning tool,
and not a config management tool.
So this idea of using terraform to manage the config for a server didn't really work out.<h4 id=-plan-><em>plan</em></h4><p>use <code>provisioner "file"</code>s on <code>null_resource</code>s to transfer the config files
necessary to run <a href=https://www.nomadproject.io/>nomad</a>.<h4 id=-results-><em>results</em></h4><p>You have to do it right the first time,
otherwise it's a manual <code>taint</code> of the resource and recreating it.
Also it doesn't create the directories for a specified path,
necessitating <code>provisioner "remote-exec"</code> just to create the dirs.<p>I should (have to?) reboot the server after everything is done,
but terraform doesn't make doing that + exiting properly / validating easy.
So I copped out and just did that part by hand.<h4 id=-files-><em>files</em></h4><h5 id=00-certstf>00_certs.tf</h5><p>This file creates a self signed CA
and a set of client certs output to a local dir
so local <code>nomad</code> cli commands can authenticate.<pre><code class=language-terraform>##################################################
# ca certs
##################################################
resource &quot;tls_private_key&quot; &quot;ca&quot; {
  algorithm   = &quot;ECDSA&quot;
  ecdsa_curve = &quot;P384&quot;
}

resource &quot;tls_self_signed_cert&quot; &quot;ca&quot; {
  key_algorithm     = tls_private_key.ca.algorithm
  private_key_pem   = tls_private_key.ca.private_key_pem
  is_ca_certificate = true

  validity_period_hours = 24 * 365 * 10

  allowed_uses = [
    &quot;cert_signing&quot;,
  ]

  subject {
    common_name  = &quot;medea.seankhliao.com&quot;
    organization = &quot;medea / seankhliao&quot;
  }
}
resource &quot;local_file&quot; &quot;ca_cert&quot; {
  content  = tls_self_signed_cert.ca.cert_pem
  filename = &quot;${path.root}/out/ca.crt&quot;
}


##################################################
# client cert
##################################################
resource &quot;tls_private_key&quot; &quot;nomad_client&quot; {
  algorithm   = &quot;ECDSA&quot;
  ecdsa_curve = &quot;P384&quot;
}
resource &quot;local_file&quot; &quot;nomad_client_key&quot; {
  content  = tls_private_key.nomad_client.private_key_pem
  filename = &quot;${path.root}/out/client.key&quot;
}

resource &quot;tls_cert_request&quot; &quot;nomad_client&quot; {
  key_algorithm   = &quot;ECDSA&quot;
  private_key_pem = tls_private_key.nomad_client.private_key_pem

  subject {
    common_name  = &quot;eevee.seankhliao.com&quot;
    organization = &quot;medea / seankhliao&quot;
  }
}
resource &quot;tls_locally_signed_cert&quot; &quot;nomad_client&quot; {
  ca_key_algorithm   = tls_private_key.ca.algorithm
  ca_private_key_pem = tls_private_key.ca.private_key_pem
  ca_cert_pem        = tls_self_signed_cert.ca.cert_pem
  cert_request_pem   = tls_cert_request.nomad_client.cert_request_pem

  validity_period_hours = 24 * 365

  allowed_uses = [
    &quot;digital_signature&quot;,
    &quot;key_encipherment&quot;,
    &quot;client_auth&quot;,
  ]
}
resource &quot;local_file&quot; &quot;nomad_client_cert&quot; {
  content  = tls_locally_signed_cert.nomad_client.cert_pem
  filename = &quot;${path.root}/out/client.crt&quot;
}
</code></pre><h5 id=01-medeatf>01_medea.tf</h5><p><a href=https://your-throne.fandom.com/wiki/Medea_Solon>medea</a>
is the name of my server.<p>This file manages the basic setup i need from a fresh image.<pre><code class=language-terraform>resource &quot;null_resource&quot; &quot;medea&quot; {
  connection {
    host        = &quot;medea.seankhliao.com&quot;
    private_key = file(pathexpand(&quot;~/.ssh/id_ed25519&quot;))
    agent       = false
  }

  provisioner &quot;remote-exec&quot; {
    inline = [
      &quot;rm /etc/sysctl.d/* || true&quot;,
      &quot;rm /etc/ssh/ssh_host_{dsa,rsa,ecdsa}_key* || true&quot;,
      &quot;pacman -Rns --noconfirm btrfs-progs gptfdisk haveged xfsprogs wget vim net-tools cronie || true&quot;,
      &quot;pacman -Syu --noconfirm neovim zip unzip&quot;,
      &quot;systemctl enable --now systemd-timesyncd&quot;,
    ]
  }
  provisioner &quot;file&quot; {
    destination = &quot;/root/.ssh/authorized_keys&quot;
    content     = &lt;&lt;-EOT
      ${file(pathexpand(&quot;~/.ssh/id_ed25519.pub&quot;))}
      ${file(pathexpand(&quot;~/.ssh/id_ed25519_sk.pub&quot;))}
      ${file(pathexpand(&quot;~/.ssh/id_ecdsa_sk.pub&quot;))}
    EOT
  }
  provisioner &quot;file&quot; {
    destination = &quot;/etc/sysctl.d/30-ipforward.conf&quot;
    content     = &lt;&lt;-EOT
      net.ipv4.ip_forward=1
      net.ipv4.conf.lxc*.rp_filter=0
      net.ipv6.conf.default.forwarding=1
      net.ipv6.conf.all.forwarding=1
    EOT
  }
  provisioner &quot;file&quot; {
    destination = &quot;/etc/modules-load.d/br_netfilter.conf&quot;
    content     = &quot;br_netfilter&quot;
  }
  provisioner &quot;file&quot; {
    destination = &quot;/etc/systemd/network/40-wg0.netdev&quot;
    content     = &lt;&lt;-EOT
      # WireGuard

      [NetDev]
      Name = wg0
      Kind = wireguard

      [WireGuard]
      PrivateKey = xxxx
      # PublicKey = lombY0b15giOmoM9t0xBi+UgVkZDoOKDaEV9+ONwH1U=
      ListenPort = 51820

      # eevee
      [WireGuardPeer]
      PublicKey = YvSLDXl3NX1ySTX2C8D72+fCVBcqSs+fmAX3uySCDAQ=
      AllowedIPs = 192.168.100.13/32

      # pixel 3
      [WireGuardPeer]
      PublicKey = 3xpGlOORQb9/yg545KX+odrup3YaslxO9ie+ztJ3Y3E=
      AllowedIPs = 192.168.100.3/32

      # arch
      [WireGuardPeer]
      PublicKey = Lr17jGvc7uwjn9LNRR+IkCkjuP8nkHTOMHbVV+onMn0=
      AllowedIPs = 192.168.100.1/24
      Endpoint = yyyy
    EOT
  }
  provisioner &quot;file&quot; {
    destination = &quot;/etc/systemd/network/41-wg0.network&quot;
    content     = &lt;&lt;-EOT
      [Match]
      Name = wg0

      [Network]
      Address = 192.168.100.2/24
    EOT
  }
}
</code></pre><h5 id=02-nomadtf>02_nomad.tf</h5><p>This file provisions the server(+client) certs for nomad
(it needs client to talk to itself),
downloads nomad and runs it with <code>systemd</code>.<pre><code class=language-terraform>##################################################
# nomad server cert
##################################################
resource &quot;tls_private_key&quot; &quot;nomad_server&quot; {
  algorithm   = &quot;ECDSA&quot;
  ecdsa_curve = &quot;P384&quot;
}

resource &quot;tls_cert_request&quot; &quot;nomad_server&quot; {
  key_algorithm   = &quot;ECDSA&quot;
  private_key_pem = tls_private_key.nomad_server.private_key_pem

  dns_names = [
    &quot;localhost&quot;,
    &quot;server.global.nomad&quot;,
    &quot;medea.seankhliao.com&quot;,
  ]

  ip_addresses = [
    &quot;127.0.0.1&quot;,
    &quot;192.168.100.2&quot;,
    &quot;65.21.73.144&quot;,
  ]

  subject {
    common_name  = &quot;medea.seankhliao.com&quot;
    organization = &quot;medea / seankhliao&quot;
  }
}
resource &quot;tls_locally_signed_cert&quot; &quot;nomad_server&quot; {
  ca_key_algorithm   = tls_private_key.ca.algorithm
  ca_private_key_pem = tls_private_key.ca.private_key_pem
  ca_cert_pem        = tls_self_signed_cert.ca.cert_pem
  cert_request_pem   = tls_cert_request.nomad_server.cert_request_pem

  validity_period_hours = 24 * 365

  allowed_uses = [
    &quot;digital_signature&quot;,
    &quot;key_encipherment&quot;,
    &quot;server_auth&quot;,
    &quot;client_auth&quot;,
  ]
}

##################################################
# nomad
##################################################
resource &quot;null_resource&quot; &quot;medea_nomad&quot; {
  depends_on = [
    null_resource.medea,
  ]

  connection {
    host        = &quot;medea.seankhliao.com&quot;
    private_key = file(pathexpand(&quot;~/.ssh/id_ed25519&quot;))
    agent       = false
  }

  provisioner &quot;file&quot; {
    destination = &quot;/etc/systemd/system/nomad.service&quot;
    content     = &lt;&lt;-EOT
      [Unit]
      Description=nomad server
      Documentation=https://www.nomadproject.io/docs/agent/
      Requires=network-online.target
      After=network-online.target

      [Service]
      Restart=on-failure
      ExecStart=/usr/local/bin/nomad agent -config /etc/nomad/server.hcl
      ExecReload=/usr/bin/kill -HUP $MAINPID
      KillSignal=SIGINT

      [Install]
      WantedBy=multi-user.target
    EOT
  }
  provisioner &quot;remote-exec&quot; {
    inline = [
      &quot;curl -Lo /tmp/nomad.zip https://releases.hashicorp.com/nomad/1.1.0/nomad_1.1.0_linux_amd64.zip&quot;,
      &quot;unzip -o /tmp/nomad.zip nomad -d /usr/local/bin&quot;,
      &quot;systemctl daemon-reload&quot;,
      &quot;systemctl enable nomad&quot;,
      &quot;rm -rf /etc/nomad || true&quot;,
      &quot;mkdir -p /etc/nomad&quot;,
    ]
  }
  provisioner &quot;file&quot; {
    destination = &quot;/etc/nomad/ca.crt&quot;
    content     = tls_self_signed_cert.ca.cert_pem
  }
  provisioner &quot;file&quot; {
    destination = &quot;/etc/nomad/server.key&quot;
    content     = tls_private_key.nomad_server.private_key_pem
  }
  provisioner &quot;file&quot; {
    destination = &quot;/etc/nomad/server.crt&quot;
    content     = tls_locally_signed_cert.nomad_server.cert_pem
  }
  provisioner &quot;file&quot; {
    destination = &quot;/etc/nomad/server.hcl&quot;
    content     = &lt;&lt;-EOT
      bind_addr = &quot;0.0.0.0&quot;
      data_dir  = &quot;/var/lib/nomad&quot;

      tls {
        http = true
        rpc  = true

        ca_file   = &quot;/etc/nomad/ca.crt&quot;
        cert_file = &quot;/etc/nomad/server.crt&quot;
        key_file  = &quot;/etc/nomad/server.key&quot;

        verify_server_hostname = true
        verify_https_client    = true
      }

      leave_on_interrupt = true
      leave_on_terminate = true

      disable_update_check = true

      server {
        enabled = true
        bootstrap_expect = 1
      }

      client {
        enabled = true
      }

      log_level = &quot;INFO&quot;
    EOT
  }
}
</code></pre><h5 id=03-consultf>03_consul.tf</h5><p>Similar, but for consul.
The other option is to run it inside nomad as a system job,
which may actually work better, since this is janky.
Once nomad has talked to consul, it doesn't like being disconnected.<pre><code class=language-terraform>##################################################
# consul server cert
##################################################
resource &quot;tls_private_key&quot; &quot;consul_server&quot; {
  algorithm   = &quot;ECDSA&quot;
  ecdsa_curve = &quot;P384&quot;
}

resource &quot;tls_cert_request&quot; &quot;consul_server&quot; {
  key_algorithm   = &quot;ECDSA&quot;
  private_key_pem = tls_private_key.consul_server.private_key_pem

  dns_names = [
    &quot;localhost&quot;,
    &quot;server.dc1.consul&quot;,
    &quot;medea.seankhliao.com&quot;,
  ]

  ip_addresses = [
    &quot;127.0.0.1&quot;,
    &quot;192.168.100.2&quot;,
    &quot;65.21.73.144&quot;,
  ]

  subject {
    common_name  = &quot;medea.seankhliao.com&quot;
    organization = &quot;medea / seankhliao&quot;
  }
}
resource &quot;tls_locally_signed_cert&quot; &quot;consul_server&quot; {
  ca_key_algorithm   = tls_private_key.ca.algorithm
  ca_private_key_pem = tls_private_key.ca.private_key_pem
  ca_cert_pem        = tls_self_signed_cert.ca.cert_pem
  cert_request_pem   = tls_cert_request.consul_server.cert_request_pem

  validity_period_hours = 24 * 365

  allowed_uses = [
    &quot;digital_signature&quot;,
    &quot;key_encipherment&quot;,
    &quot;server_auth&quot;,
    &quot;client_auth&quot;,
  ]
}

##################################################
# consul
##################################################
resource &quot;null_resource&quot; &quot;medea_consul&quot; {
  depends_on = [
    null_resource.medea,
  ]

  connection {
    host        = &quot;medea.seankhliao.com&quot;
    private_key = file(pathexpand(&quot;~/.ssh/id_ed25519&quot;))
    agent       = false
  }

  provisioner &quot;file&quot; {
    destination = &quot;/etc/systemd/system/consul.service&quot;
    content     = &lt;&lt;-EOT
      [Unit]
      Description=Consul Agent
      Documentation=https://consul.io/docs/
      Requires=network-online.target
      After=network-online.target

      [Service]
      Restart=on-failure
      ExecStart=/usr/local/bin/consul agent -config-file /etc/consul/server.hcl
      ExecReload=/usr/bin/kill -HUP $MAINPID
      KillSignal=SIGINT

      [Install]
      WantedBy=multi-user.target
    EOT
  }
  provisioner &quot;remote-exec&quot; {
    inline = [
      &quot;curl -Lo /tmp/consul.zip https://releases.hashicorp.com/consul/1.9.5/consul_1.9.5_linux_amd64.zip&quot;,
      &quot;unzip -o /tmp/consul.zip consul -d /usr/local/bin&quot;,
      &quot;systemctl daemon-reload&quot;,
      &quot;systemctl enable consul&quot;,
      &quot;rm -rf /etc/consul || true&quot;,
      &quot;mkdir -p /etc/consul&quot;,
    ]
  }
  provisioner &quot;file&quot; {
    destination = &quot;/etc/consul/ca.crt&quot;
    content     = tls_self_signed_cert.ca.cert_pem
  }
  provisioner &quot;file&quot; {
    destination = &quot;/etc/consul/server.key&quot;
    content     = tls_private_key.consul_server.private_key_pem
  }
  provisioner &quot;file&quot; {
    destination = &quot;/etc/consul/server.crt&quot;
    content     = tls_locally_signed_cert.consul_server.cert_pem
  }
  provisioner &quot;file&quot; {
    destination = &quot;/etc/consul/server.hcl&quot;
    content     = &lt;&lt;-EOT
      bind_addr = &quot;0.0.0.0&quot;
      data_dir  = &quot;/var/lib/consul&quot;
      ports {
        http = -1
        https = 8501
        grpc = 8502
      }

      ca_file   = &quot;/etc/consul/ca.crt&quot;
      cert_file = &quot;/etc/consul/server.crt&quot;
      key_file  = &quot;/etc/consul/server.key&quot;

      verify_incoming = true
      verify_server_hostname = true

      leave_on_terminate = true

      disable_update_check = true

      server = true
      bootstrap_expect = 1

      client_addr = &quot;0.0.0.0&quot;

      ui_config {
        enabled = true
      }

      log_level = &quot;INFO&quot;
    EOT
  }
}
</code></pre><footer><a href=https://seankhliao.com/>home</a>
|
<a href=https://seankhliao.com/blog/>blog</a>
|
<a href=https://github.com/seankhliao>github</a></footer>