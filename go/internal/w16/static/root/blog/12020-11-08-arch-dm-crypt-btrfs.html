<!doctype html><html lang=en><meta charset=utf-8><meta name=viewport content="width=device-width,minimum-scale=1,initial-scale=1"><title>arch btrfs with encryption</title><script>(function(b,d,e,a,g){b[a]=b[a]||[],b[a].push({"gtm.start":(new Date).getTime(),event:"gtm.js"});var f=d.getElementsByTagName(e)[0],c=d.createElement(e),h=a!="dataLayer"?"&l="+a:"";c.async=!0,c.src="https://www.googletagmanager.com/gtm.js?id="+g+h,f.parentNode.insertBefore(c,f)})(window,document,"script","dataLayer","GTM-TLVN7D6")</script><link rel=canonical href=https://seankhliao.com/blog/12020-11-08-arch-dm-crypt-btrfs/><link rel=manifest href=/manifest.json><meta name=theme-color content="#000000"><meta name=description content="baby steps, one at a time, now you want some extra encryption"><link rel=icon href=https://seankhliao.com/favicon.ico><link rel=icon href=https://seankhliao.com/static/icon.svg type=image/svg+xml sizes=any><link rel=apple-touch-icon href=https://seankhliao.com/static/icon-192.png><style>*{box-sizing:border-box}:root{background:#000;color:#eceff1;font:18px inconsolata,monospace}@font-face{font-family:inconsolata;font-style:normal;font-weight:400;font-display:swap;src:local("Inconsolata"),local("Inconsolata-Regular"),url(https://seankhliao.com/static/inconsolata-var.woff2)format("woff2-variations"),url(https://seankhliao.com/static/inconsolata-400.woff2)format("woff2")}@font-face{font-family:inconsolata;font-style:normal;font-weight:700;font-display:swap;src:local("Inconsolata Bold"),local("Inconsolata-Bold"),url(https://seankhliao.com/static/inconsolata-var.woff2)format("woff2-variations"),url(https://seankhliao.com/static/inconsolata-700.woff2)format("woff2")}@font-face{font-family:lora;font-style:normal;font-weight:400;font-display:swap;src:local("Lora"),local("Lora-Regular"),url(https://seankhliao.com/static/lora-var.woff2)format("woff2-variations"),url(https://seankhliao.com/static/lora-400.woff2)format("woff2")}@font-face{font-family:lora;font-style:normal;font-weight:700;font-display:swap;src:local("Lora Bold"),local("Lora-Bold"),url(https://seankhliao.com/static/lora-var.woff2)format("woff2-variations"),url(https://seankhliao.com/static/lora-700.woff2)format("woff2")}body{grid:20vh 60vh/1fr repeat(3,minmax(90px,280px))1fr;display:grid;gap:0 1em;margin:0;padding:1vmin;background:#000;color:#eceff1;font:18px inconsolata,monospace}body>*{grid-column:2/span 3}h1{font-size:4.5vmin;grid-area:1/4/span 1/span 2;margin:0;place-self:end}h2{color:#999;font-size:3.5vmin;grid-area:2/4/span 1/span 2;place-self:start end;text-align:right}hgroup{font:700 5vmin lora,serif;grid-area:1/1/span 2/span 2;margin:0;place-self:end start}hgroup a{display:grid;grid:repeat(2,10vmin)/repeat(8,10vmin);place-content:center center}hgroup *:nth-child(n+5){grid-row:2/span 1}footer,iframe,pre,table,picture{grid-column:1/span 5;margin:.25em -1vmin 2em}picture img{width:100%;margin:auto}h3,h4,picture{margin:25vh 0 .25em}h5,h6{margin:1.5em 0 .25em}h3{font-size:2.441em}h4{font-size:1.953em}h5{font-size:1.563em}h6{font-size:1.25em}p{line-height:1.5;margin:0 0 1em}footer{margin:10vh auto 3vh}a,a:visited{color:inherit;font-weight:700;text-decoration:underline 1px #707070}a:hover{color:#a06be0;transition:color .16s;text-decoration:underline 1px #a06be0}h1 a,h1 a:hover,h1 a:visited,hgroup a,hgroup a:hover,hgroup a:visited{color:inherit;text-decoration:none}ul{list-style:none;margin:0}ul>*{margin:.5em;line-height:1.5em}ul>li:before{content:"Â»";margin:0 1ch 0 -3ch;position:absolute}ol>*{line-height:1.75em}blockquote{margin:1em;padding:.25em 1em;border-left:1ch solid #999}code{background:#303030;font:1em inconsolata,monospace;padding:.1em}pre{background:#303030;overflow-x:scroll;padding:1em}pre::-webkit-scrollbar{display:none}pre code{padding:0}iframe{margin:auto}em{color:#a06be0;background-color:unset;font-style:normal;font-weight:700}time{color:#999}table{border-collapse:collapse;border-style:hidden}th,td{padding:.4em;text-align:left}th{font-weight:700;border-bottom:.2em solid #999}tr:nth-child(5n) td{border-bottom:.1em solid #999}tbody tr:hover{background:#404040}noscript iframe{height:0;width:0;display:none;visibility:hidden}</style><noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-TLVN7D6" height=0 width=0 style=display:none;visibility:hidden></iframe></noscript><h1><a href=/blog/>b<em>log</em></a></h1><h2>12020-11-08</h2><hgroup><a href=/><span>S</span><span>E</span><span>A</span><span>N</span>
<em>K</em><em>.</em><em>H</em><em>.</em>
<span>L</span><span>I</span><span>A</span><span>O</span></a></hgroup><h3 id=-encryption-><em>encryption</em></h3><p>Why not encrypt everything, you think.
Well why not?<p>So you want something that plays nice with btrfs.
And you don't feel like touching lvm so soon.<h4 id=-options-><em>options</em></h4><p>dm-crypt/luks on an entire partition, btrfs inside with subvolumes:
almost everything is encrypted.<p>btrfs on partition, systemd-homed for user:
your user home can be encrypted, nothing else is,
eg: wifi passwords in <code>/etc/wpa_supplicant/</code> or <code>/var/lib/iwd/</code>,
wireguard passwords somewhere in <code>/etc/</code><h4 id=-setup-><em>setup</em></h4><ol><li>create paritions:<ol><li>EFI partition<li>root partition</ol><li>create encrypted device<ol><li><code>cryptsetup luksFormat /dev/nvme0n1p2</code><li><code>cryptsetup open /dev/nvme0n1p2 root</code> last arg is the name to be used in <code>/dev/mapper</code></ol><li>create filesystems<ol><li><code>mkfs.fat -F 32 /dev/nvme0n1p1</code><li><code>mkfs.btrfs /dev/mapper/root</code></ol><li>setup btrfs<ol><li><code>mount -o compress=zstd /dev/mapper/root /mnt</code><li><code>mkdir /mnt/arch</code><li><code>btrfs subvolume create /mnt/arch/@</code><li><code>umount /mnt</code></ol><li>mount filesystems<ol><li><code>mount -o compress=zstd,subvol=arch/@ /dev/mapper/root /mnt</code><li><code>mkdir /mnt/boot</code><li><code>mount /dev/nvme0n1p1 /mnt/boot</code></ol><li><code>timedatectl set-ntp true</code><li><code>iwd station wlan0 connect $network</code><li><code>reflector --save /etc/pacman.d/mirrorlist -f 5 -p https</code><li><code>pacstrap /mnt base base-devel linux linux-firmware intel-ucode btrfs-progs zsh zsh-completions iwd git neovim</code>, minimal set of things to work confortable after reboot<li><code>genfstab -U /mnt >> /mnt/etc/fstab</code>, alternatively edit it to use <code>/dev/mapper/root</code><li><code>arch-chroot /mnt</code><li><code>passwd</code><li>edit <code>/etc/mkinitcpio.conf</code> set <code>HOOKS=(base systemd autodetect keyboard sd-vconsole modconf block sd-encrypt filesystems fsck)</code>, sd-vconsole is optional<li>add <code>/etc/crypttab.initramfs</code> with <code>root UUID=...</code>, this will get included in the initramfs so no kernel cmdlines are needed<li>regenerate initramfs, <code>mkinitcpio -p</code> or the foolproof way <code>pacman -S linux</code><li><code>bootctl install</code><li><code>echo "default arch\ntimeout 0\nconsole-mode max" > /boot/loader/loader.conf</code><li>create loader entry, alternatively <code>root=/dev/mapper/root</code> is reliable enough since it is mapped from a UUID in our <code>/etc/crypttab.initramfs</code><li>continue after rebooting into new system, some tools require the right systemd/dbus setup not available in chroot.</ol><h4 id=-bootloaderentriesarchconf-><em>/boot/loader/entries/arch.conf</em></h4><pre><code class=language-txt>title   Arch Linux
linux   /vmlinuz-linux
initrd  /intel-ucode.img
initrd  /initramfs-linux.img
options root=/dev/mapper/root rootflags=compress=zstd:3,ssd,space_cache,subvol=arch/@ quiet rw
</code></pre><h4 id=-notes-><em>notes</em></h4><p>The archwiki will at times refer to a boot partition and a efi/esp partition.
UEFI only cares about the bit that is FAT32 and contains efi things it can load: systemd-boot, kernel EFISTUB, grub, ...
Arch cares about the "boot partition" because by default hooks will dump the resulting files into <code>/boot</code><p>The lazy way mounts the efi partition at <code>/boot</code>, UEFI things are contained in <code>/boot/EFI</code>,
the disadvantages being you need a bigger EFI partition to hold the kernel and stuff and they're not really protected.<p>The more involved way is the encrypted boot: grub (only grub supports this) is installed onto the unencrypted EFI partition,
where it knows how to decrypt the encrypted boot partition and start the kernel from there.
Note this doesn't protect against someone modifying your bootloader.<p>The correct solution is Secure Boot with your own keys: UEFI firmware verifies the bootloader,
the bootloader verifies the kernel, the kernel verifies its drivers.
It doesn't matter that the bootloader and the kernel sit out in the open unencrypted,
they shouldn't have secrets in them and any attempt to tamper with them would invalidate the signature and break the verification chain.<h5 id=-decrypting-><em>decrypting</em></h5><p>you can either specify the devices to decrypt in the boot cmdline through the bootloader or as a file which gets built into the initramfs,
cmdlines will override all file mounts.<p><code>/etc/crypttab</code> is not necessary since the root device (our only one) needs to already be unlocked when it is read.<h5 id=-systemd-homed-><em>systemd-homed</em></h5><p>you can use a luks device to back a systemd-homed home,
so you can have a luks in your luks...<p>alternatively you can back it with a btrfs subvolume in your already
encrypted system.<footer><a href=https://seankhliao.com/>home</a>
|
<a href=https://seankhliao.com/blog/>blog</a>
|
<a href=https://github.com/seankhliao>github</a></footer>