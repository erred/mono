<!doctype html><html lang=en><meta charset=utf-8><meta name=viewport content="width=device-width,minimum-scale=1,initial-scale=1"><title>go modules tldr</title><script>(function(b,d,e,a,g){b[a]=b[a]||[],b[a].push({"gtm.start":(new Date).getTime(),event:"gtm.js"});var f=d.getElementsByTagName(e)[0],c=d.createElement(e),h=a!="dataLayer"?"&l="+a:"";c.async=!0,c.src="https://www.googletagmanager.com/gtm.js?id="+g+h,f.parentNode.insertBefore(c,f)})(window,document,"script","dataLayer","GTM-TLVN7D6")</script><link rel=canonical href=https://seankhliao.com/blog/12020-07-30-go-modules-tldr/><link rel=manifest href=/manifest.json><meta name=theme-color content="#000000"><meta name=description content="practical go modules"><link rel=icon href=https://seankhliao.com/favicon.ico><link rel=icon href=https://seankhliao.com/static/icon.svg type=image/svg+xml sizes=any><link rel=apple-touch-icon href=https://seankhliao.com/static/icon-192.png><style>*{box-sizing:border-box}:root{background:#000;color:#eceff1;font:18px inconsolata,monospace}@font-face{font-family:inconsolata;font-style:normal;font-weight:400;font-display:swap;src:local("Inconsolata"),local("Inconsolata-Regular"),url(https://seankhliao.com/static/inconsolata-var.woff2)format("woff2-variations"),url(https://seankhliao.com/static/inconsolata-400.woff2)format("woff2")}@font-face{font-family:inconsolata;font-style:normal;font-weight:700;font-display:swap;src:local("Inconsolata Bold"),local("Inconsolata-Bold"),url(https://seankhliao.com/static/inconsolata-var.woff2)format("woff2-variations"),url(https://seankhliao.com/static/inconsolata-700.woff2)format("woff2")}@font-face{font-family:lora;font-style:normal;font-weight:400;font-display:swap;src:local("Lora"),local("Lora-Regular"),url(https://seankhliao.com/static/lora-var.woff2)format("woff2-variations"),url(https://seankhliao.com/static/lora-400.woff2)format("woff2")}@font-face{font-family:lora;font-style:normal;font-weight:700;font-display:swap;src:local("Lora Bold"),local("Lora-Bold"),url(https://seankhliao.com/static/lora-var.woff2)format("woff2-variations"),url(https://seankhliao.com/static/lora-700.woff2)format("woff2")}body{grid:20vh 60vh/1fr repeat(3,minmax(90px,280px))1fr;display:grid;gap:0 1em;margin:0;padding:1vmin;background:#000;color:#eceff1;font:18px inconsolata,monospace}body>*{grid-column:2/span 3}h1{font-size:4.5vmin;grid-area:1/4/span 1/span 2;margin:0;place-self:end}h2{color:#999;font-size:3.5vmin;grid-area:2/4/span 1/span 2;place-self:start end;text-align:right}hgroup{font:700 5vmin lora,serif;grid-area:1/1/span 2/span 2;margin:0;place-self:end start}hgroup a{display:grid;grid:repeat(2,10vmin)/repeat(8,10vmin);place-content:center center}hgroup *:nth-child(n+5){grid-row:2/span 1}footer,iframe,pre,table,picture{grid-column:1/span 5;margin:.25em -1vmin 2em}picture img{width:100%;margin:auto}h3,h4,picture{margin:25vh 0 .25em}h5,h6{margin:1.5em 0 .25em}h3{font-size:2.441em}h4{font-size:1.953em}h5{font-size:1.563em}h6{font-size:1.25em}p{line-height:1.5;margin:0 0 1em}footer{margin:10vh auto 3vh}a,a:visited{color:inherit;font-weight:700;text-decoration:underline 1px #707070}a:hover{color:#a06be0;transition:color .16s;text-decoration:underline 1px #a06be0}h1 a,h1 a:hover,h1 a:visited,hgroup a,hgroup a:hover,hgroup a:visited{color:inherit;text-decoration:none}ul{list-style:none;margin:0}ul>*{margin:.5em;line-height:1.5em}ul>li:before{content:"Â»";margin:0 1ch 0 -3ch;position:absolute}ol>*{line-height:1.75em}blockquote{margin:1em;padding:.25em 1em;border-left:1ch solid #999}code{background:#303030;font:1em inconsolata,monospace;padding:.1em}pre{background:#303030;overflow-x:scroll;padding:1em}pre::-webkit-scrollbar{display:none}pre code{padding:0}iframe{margin:auto}em{color:#a06be0;background-color:unset;font-style:normal;font-weight:700}time{color:#999}table{border-collapse:collapse;border-style:hidden}th,td{padding:.4em;text-align:left}th{font-weight:700;border-bottom:.2em solid #999}tr:nth-child(5n) td{border-bottom:.1em solid #999}tbody tr:hover{background:#404040}noscript iframe{height:0;width:0;display:none;visibility:hidden}</style><noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-TLVN7D6" height=0 width=0 style=display:none;visibility:hidden></iframe></noscript><h1><a href=/blog/>b<em>log</em></a></h1><h2>12020-07-30</h2><hgroup><a href=/><span>S</span><span>E</span><span>A</span><span>N</span>
<em>K</em><em>.</em><em>H</em><em>.</em>
<span>L</span><span>I</span><span>A</span><span>O</span></a></hgroup><h3 id=-go-modules-><em>go modules</em></h3><p>Go modules are a collection of packages which share a
<em>single unit of versioning</em>.<p>design goal: given the same set of initial dependencies
always select the same set of all dependencies.
(in contrast with SAT solvers which try to select the latest version of all dependencies)<h4 id=-basics-><em>basics</em></h4><p>check in <code>go.mod</code> and <code>go.sum</code><h5 id=-semver-><em>semver</em></h5><p>Go modules depends on modules following semver as defined by
<a href=https://semver.org/>semver.org</a>.<p><code>vX.Y.Z-a+b</code><ul><li><code>X</code>: major version, increment on breaking change<li><code>Y</code>: minor version, increment on new feature<li><code>Z</code>: patch version, increment on bugfix<li><code>a</code>: optional prerelease specifier, ordered alphabetically<li><code>b</code>: optional build specifier, ignored in version selection</ul><p><code>v0</code> and <code>v1</code> share the same namespace and allow seamless upgrading<h5 id=-version--selection><em>version</em> selection</h5><p>example: the following modules / versions are available<pre><code class=language-txt>module-a v0.1.0 v0.2.0 v0.3.0 v1.0.0 v1.1.0-alpha.1
module-b v1.4.0 v1.5.0 v1.6.0 v2.0.0 v2.1.0
module-c v0.7.0 v0.8.0 v0.9.0
</code></pre><h6 id=-new--dependency><em>new</em> dependency</h6><p>if unspecified, select the latest released version with the current major version<p><em>example</em>:<ul><li>adding a new dependency <code>module-a</code>: <code>v1.0.0</code> is selected<li>adding a new dependency <code>module-b</code>: <code>v1.6.0</code> is selected<li>adding a new dependency <code>module-b/v2</code>: <code>v2.1.0</code> is selected</ul><h6 id=-indirect---existing-dependency><em>indirect</em> / existing dependency</h6><p><em>example</em>:<ul><li><code>module-a</code> requires <code>module-c</code> @ <code>v0.7.0</code><li><code>module-b</code> requires <code>module-c</code> @ <code>v0.8.0</code><li><code>v0.8.0</code> of <code>module-c</code> is selected</ul><h5 id=-proxy-><em>proxy</em></h5><p>By default the go toolchain will use a public proxy <code>https://proxy.golang.org</code>.
This offers faster querying and download speeds.<ul><li><code>go env GOPROXY</code> check current settings<li>once things are in the proxy they cannot be deleted<li>practice with prerelease tags, you don't want to mess up the name you want to use<li>moving tags or rewriting history will likely invalidate checksums resulting in errors<li>the proxy has caches, bypass with <code>GOPROXY=direct</code> (fetches directly from source)<li>private modules are not available through the proxy, set <code>GOPRIVATE</code><li>if you're developing multiple modules with constantly updated versions you may also want to set <code>GOPRIVATE</code> to bypass the cache<li>RedHat patched the toolchain to bypass the default proxy</ul><h5 id=-multi-module--repositories><em>multi module</em> repositories</h5><ul><li>Don't<li>modules have no parent-child / hierarchical relationships<li>just don't.</ul><h4 id=-gomod-><em>go.mod</em></h4><h5 id=-create--a-module><em>create</em> a module</h5><p>in <code>go.mod</code>:<pre><code class=language-go.mod>module example.com/module
</code></pre><p>the first part of the name <em>SHOULD</em> have a dot in the name,
preferably domain like so <code>go get</code> can work,
see <em>vanity import paths</em>.
Only <code>test/</code> and <code>example/</code> are reserved to not need a dot.<ul><li><code>go mod init example.com/module</code><li><code>go mod init example.com/module/v2</code><li><code>go mod init github.com/seankhliao/testrepo</code><li><code>go mod init github.com/seankhliao/testrepo/v3</code><li><code>go mod init test/module</code></ul><h5 id=-go--directive><em>go</em> directive</h5><p>in <code>go.mod</code>:<pre><code class=language-go.mod>go 1.X
</code></pre><p>Where <code>11 &lt;= X &lt;= current version</code>.
Lower versions guarantee the availability of features at that version,
but restrict the availability of newer versions.
Go does not automatically download older/newer toolchains,
but the current one will report a mismatch if it fails to build.<h5 id=-require--directive><em>require</em> directive</h5><ul><li><code>require example.com/module-a v1.2.3</code><li><code>require example.com/module-a v2.3.4 // +incompatible</code><li><code>require example.com/module-a v1.2.3-20200231-sdndsjcn</code></ul><h5 id=-replace--directive><em>replace</em> directive</h5><p>are only applied in the main module (the <code>go build</code> is being run from)<ul><li><code>replace example.com/module-a v1.2.3 => example.com/module-a v1.0.0</code><li><code>replace example.com/module-a => exmaple.com/module-a v1.0.0</code><li><code>replace example.com/module-a => example2.com/module-a v1.2.3</code><li><code>replace example.com/module-a => ../module-a</code></ul><h5 id=-exclude--directive><em>exclude</em> directive</h5><ul><li><code>exclude example.com v1.2.3</code></ul><h4 id=-gosum-><em>go.sum</em></h4><p><code>go.sum</code> is not used for module selected / dependency resolution.
It is purely for security / integrity.
Do not worry about what's inside<h4 id=-dependency--management><em>dependency</em> management</h4><h5 id=-add--a-dependency><em>add</em> a dependency</h5><p>Add the dependency in your code with <code>import "example.com/module"</code>,
and run <code>go run .</code>, <code>go build</code>, <code>go mod tidy</code> to automatically update <code>go.mod</code>.
The latest version will be selected and recorded (if not already there).<ul><li><code>go get example.com/module@latest</code><li><code>go get example.com/module@v1.2.3</code><li><code>go get example.com/module@master</code> (or any other branch)<li><code>go get example.com/module@sj4jdn3</code> (or any commit)</ul><h5 id=-update--a-dependency><em>update</em> a dependency</h5><ul><li><code>go get -u=patch example.com/module</code><li><code>go get -u example.com/module</code><li><code>go get -u all</code><li><code>go get -u ./...</code></ul><h5 id=-remove--a-dependency><em>remove</em> a dependency</h5><p>Remove all imports in your code,
run <code>go mod tidy</code>.<h4 id=-vendor-><em>vendor</em></h4><p>Vendoring is not necessary to guarantee the version of modules used,
but you may want it to colocate your dependencies with your code,
for auditing reasons, or for guaranteeing the availability of dependencies.<ul><li>create or sync: <code>go mod vendor</code><li>go will rewrite <code>vendor/</code> contents, do not modify<li>go >= 1.14 will use <code>vendor/</code> automatically if the directory is available<li>go &lt;= 1.13 needs the <code>-mod=vendor</code> flag</ul><h4 id=-release--new-versions><em>release</em> new versions</h4><h5 id=-patch--versions><em>patch</em> versions</h5><p>tag a new release<h5 id=-minor--versions><em>minor</em> versions</h5><p>tag a new release<h5 id=-major--versions><em>major</em> versions</h5><h6 id=v0---v1>v0 -> v1</h6><p>tag a new release<h6 id=v2>v2+</h6><p>update <code>go.mod</code> to new major version,<ul><li><code>module example.com/module</code> => <code>module example.com/module/v2</code><li><code>module example.com/module/v2</code> => <code>module example.com/module/v3</code></ul><p>update all internal imports to use the new import path
(unless you want to depend on an older version of yourself)<ul><li><code>import "example.com/module/package"</code> => <code>import "example.com/module/v2/package"</code><li><code>import "example.com/module/v2/package"</code> => <code>import "example.com/module/v3/package"</code></ul><h4 id=-backwards--compatibility><em>backwards</em> compatibility</h4><p>Sometimes you need to support legacy versions of go.<h5 id=-do-nothing-><em>do nothing</em></h5><p>update <code>go.mod</code> and imports as above, tag a new release.<ul><li>go modules users will import through <code>example.com/module/v2</code><li>gopath users will import through <code>example.com/module</code><li>gopath users will not be able to easily remain on previous versions</ul><h5 id=release-branch>release branch</h5><p>cut a new branch for every release
(major / minor / patch depends on how much granularity you want to support).<ul><li>go modules users will import through <code>example.com/module/v2</code><li>gopath users will import through <code>example.com/module</code><li>gopath users can easily get and use a previous release</ul><h5 id=go1-branch>go1 branch</h5><p>similar to the above approaches except the <code>go1</code> branch has higher priority than the default branch<h5 id=major-subdirectory>major subdirectory</h5><p>Keep all existing code.
Create a <code>vX</code> subdirectory where <code>X</code> == major version, ex <code>v2</code>.
<code>go mod init example.com/module/vX</code> in the directory and copy all the other code in.<ul><li>go modules users will import through <code>example.com/module/v2</code><li>gopath users will import through <code>example.com/module/v2</code><li>bloats your repo</ul><h4 id=-querying--modules><em>querying</em> modules</h4><ul><li><code>go mod why</code><li><code>go mod graph</code><li><code>go list -m -f {{ ... }}</code></ul><footer><a href=https://seankhliao.com/>home</a>
|
<a href=https://seankhliao.com/blog/>blog</a>
|
<a href=https://github.com/seankhliao>github</a></footer>