env:
  CGO_ENABLED: "0"
  GOFLAGS: "-trimpath"
steps:
  - group: Go Latest
    steps:
      - label: Install latest Go release
        key: latestgo
        commands:
          - go run ./cli/cmd/latestgo > .latestgo
          - go install golang.org/dl/$(cat .latestgo)@latest
          - ~/go/bin/$(cat .latestgo) download
          - ln -s ~/go/bin/$(cat .latestgo) ~/go/bin/go
      - label: go vet
        depends_on: ["latestgo"]
        command: ~/go/bin/go vet ./...
      - label: go test
        depends_on: ["latestgo"]
        command: ~/go/bin/go test ./...
      - label: go build
        depends_on: ["latestgo"]
        command: ~/go/bin/go build -ldflags='-s -w' -o /dev/null ./...
  - group: Go Tip
    steps:
      - label: Install tip go
        key: tipgo
        commands:
          - go install golang.org/dl/gotip@latest
          - ~/go/bin/gotip download
      - label: go vet
        depends_on: ["tipgo"]
        command: ~/go/bin/gotip vet ./...
      - label: go test
        depends_on: ["tipgo"]
        command: ~/go/bin/gotip test ./...
      - label: go build
        depends_on: ["tipgo"]
        commands:
          - mkdir -p bin
          - ~/go/bin/gotip build -ldflags='-s -w' -o bin/ ./...
  - wait
  - label: copy to system
    command: sudo cp bin/* /usr/local/bin
  - label: restart deployments
    command: sudo systemctl restart {{matrix}}
    matrix:
      - blog
      - earbug
      - ghdefaults
      - singlepage@liaodev
      - singlepage@medea
      - singlepage@stylesheet
      - vanity
