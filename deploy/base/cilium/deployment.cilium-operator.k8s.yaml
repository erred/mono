# Source: cilium/templates/cilium-operator/deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: cilium-operator
  namespace: kube-system
  labels:
    name: cilium-operator
    io.cilium/app: operator
spec:
  # See docs on ServerCapabilities.LeasesResourceLock in file pkg/k8s/version/version.go
  # for more details.
  replicas: 1
  selector:
    matchLabels:
      name: cilium-operator
      io.cilium/app: operator
  template:
    metadata:
      labels:
        name: cilium-operator
        io.cilium/app: operator
      annotations:
    spec:
      restartPolicy: Always
      serviceAccountName: "cilium-operator"
      serviceAccount: "cilium-operator"
      hostNetwork: true
      priorityClassName: system-cluster-critical
      containers:
      - name: cilium-operator
        image: quay.io/cilium/operator-generic:v1.11.2@sha256:4c8bea6818ee3e4932f99e9c1d7efa88b8c0f3cd516160caec878406531e45e7
        command:
        - cilium-operator-generic
        args:
        - --config-dir=/tmp/cilium/config-map
        - --debug=$(CILIUM_DEBUG)
        env:
        - name: K8S_NODE_NAME
          valueFrom:
            fieldRef:
              apiVersion: v1
              fieldPath: spec.nodeName
        - name: CILIUM_K8S_NAMESPACE
          valueFrom:
            fieldRef:
              apiVersion: v1
              fieldPath: metadata.namespace
        - name: CILIUM_DEBUG
          valueFrom:
            configMapKeyRef:
              name: cilium-config
              key: debug
              optional: true
        - name: KUBERNETES_SERVICE_HOST
          value: "192.168.100.1"
        - name: KUBERNETES_SERVICE_PORT
          value: "6443"
        volumeMounts:
        - name: cilium-config-path
          readOnly: true
          mountPath: /tmp/cilium/config-map
        - name: etcd-config-path
          readOnly: true
          mountPath: /var/lib/etcd-config
        - name: etcd-secrets
          readOnly: true
          mountPath: /var/lib/etcd-secrets
        livenessProbe:
          httpGet:
            port: 9234
            host: "127.0.0.1"
            path: /healthz
            scheme: HTTP
          initialDelaySeconds: 60
          periodSeconds: 10
          timeoutSeconds: 3
        imagePullPolicy: IfNotPresent
      volumes:
      # To read the configuration from the config map
      - name: cilium-config-path
        configMap:
          name: cilium-config
      # To read the etcd config stored in config maps
      - name: etcd-config-path
        configMap:
          name: cilium-config
          # note: the leading zero means this number is in octal representation: do not remove it
          defaultMode: 0400
          items:
          - key: etcd-config
            path: etcd.config
            # To read the k8s etcd secrets in case the user might want to use TLS
      - name: etcd-secrets
        secret:
          # note: the leading zero means this number is in octal representation: do not remove it
          defaultMode: 0400
          optional: true
          secretName: cilium-etcd-secrets
      # In HA mode, cilium-operator pods must not be scheduled on the same
      # node as they will clash with each other.
      affinity:
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
          - labelSelector:
              matchExpressions:
              - key: io.cilium/app
                operator: In
                values:
                - operator
            topologyKey: kubernetes.io/hostname
      tolerations:
      - operator: Exists
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 1
